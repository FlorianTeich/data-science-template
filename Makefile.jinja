.PHONY: tests coverage lint format ty clean docs docs_live mlflow install deps sbom audit docker docker_compose stubs

tests:
	@echo "ğŸ§ª Running tests..."
	@uv run pytest

mutations:
	@echo "ğŸ§¬ Running mutation tests..."
	@uv run mutmut run
	@uv run mutmut browse

coverage:
	@echo "ğŸ“Š Running coverage..."
	@uv run coverage run -m pytest
	@uv run coverage html
	@uv run coverage report -m

lint:
	@echo "ğŸ” Running linters..."
	@uv run ruff check {{project_name}} tests $(LIB_DIR)
	@if command -v prettier >/dev/null 2>&1; then \
	    npx prettier . --check; \
	else \
	    echo "Skipping prettier..."; \
	fi
	@if command -v hadolint >/dev/null 2>&1; then \
	    hadolint Dockerfile; \
	else \
	    echo "Skipping hadolint..."; \
	fi
	@if command -v dotenv-linter >/dev/null 2>&1; then \
	    dotenv-linter; \
	else \
	    echo "Skipping dotenv-linter..."; \
	fi
	@if command -v dclint >/dev/null 2>&1; then \
	    dclint; \
	else \
	    echo "Skipping dclint..."; \
	fi
	@if command -v checkov >/dev/null 2>&1; then \
	    checkov --deployment-manifests; \
	else \
	    echo "Skipping checkov..."; \
	fi

format:
	@echo "âœ¨ Formatting..."
	@uv run ruff format {{project_name}} tests
	@if command -v prettier >/dev/null 2>&1; then \
	    npx prettier . --write; \
	else \
	    echo "Skipping prettier..."; \
	fi

ty:
	@echo "ğŸ“ Type checking..."
	@uv run ty check {{project_name}} tests

clean:
	@echo "ğŸ§¹ Cleaning up..."
	@rm -rf .pytest_cache .coverage htmlcov coverage.xml 

docs:
	@echo "ğŸ“š Building documentation..."
	@uv run mkdocs build -f docs/mkdocs.yaml

docs_live:
	@echo "ğŸ“– Building documentation..."
	@uv run mkdocs build -f docs/mkdocs.yaml
	@uv run mkdocs serve -f docs/mkdocs.yaml

mlflow:
	@echo "ğŸ“ˆ Starting mlflow..."
	@uv run mlflow server

install:
	@echo "ğŸ“¦ Installing env..."
	@uv venv
	@uv pip install ."[tools,datascience]"

deps:
	@echo "ğŸ§¾ Inspect dependencies..."
	@uv run deptry .

sbom:
	@echo "ğŸªª Creating SBOM..."
	@uv run cyclonedx-py env -o sbom.json

audit:
	@echo "ğŸ” Auditing dependencies..."
	@uv run pip-audit

docker:
	@echo "ğŸ³ Building docker image...."
	@docker build -t {{ project_name }} .

docker_compose:
	@echo "ğŸ›³ï¸ Starting Containers..."
	@docker compose up

stubs:
	@echo "ğŸ“ Creating stubs..."
	@uv run pyright --createstub lib_a
